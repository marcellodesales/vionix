name: Decodes the generated base64 stream of configuration required
description: Decodes the stream to files

author: seceng-devsecops-platform

branding:
  icon: anchor
  color: blue

inputs:
  config-stream: 
    description: "The base64 encoded stream to be decoded"
    required: true

outputs:
  decode-output:
    description: "The result of decoding for verification"
    value: ${{ steps.response.outputs.decodeOutput }}

runs:
  using: composite
  steps:
    - name: Show the current env
      shell: bash
      run: env

    - name: Parse out config stream
      if: ${{ inputs.config-stream != '' }}
      shell: bash
      run: |
        echo "Creating the config stream file at config-stream.base64"
        echo ${{ inputs.config-stream }} > config-stream.base64
        ls -la config-stream.base64

        echo "Parsing terraform-config.tar.gz"
        base64 -d config-stream.base64 > config-stream.tar.gz

        echo "Checking config integrity"
        tar -tvf config-stream.tar.gz
        tar -tvf config-stream.tar.gz > stream-out.txt

        echo "Unpacking configs"
        tar zxpvf config-stream.tar.gz

        echo 'decodeOutput<<EOF' >> $GITHUB_OUTPUT
        cat stream-out.txt >> $GITHUB_OUTPUT
        echo 'EOF' >> $GITHUB_OUTPUT

        rm -f stream-out.txt
