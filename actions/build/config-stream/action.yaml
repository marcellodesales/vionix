name: Generates base64 stream of configuration required
description: Generate a stream value in base64 format of any file, including binary

author: seceng-devsecops-platform

branding:
  icon: anchor
  color: blue

inputs:
  file-paths:
    description: "The content of the .env file to be loaded"
    required: true

  dir-paths:
    description: "The content of the .env file to be loaded"
    required: true

outputs:
  base64-stream:
    description: "The stream value to be used for configuration"
    value: ${{ steps.response.outputs.base64Stream }}

runs:
  using: composite
  steps:

    - name: Show the current env
      shell: bash
      run: env

    - name: Setup additional credentials based on the given .env file
      shell: bash
      env:
        FILE_PATHS: '${{ inputs.file-paths }}'
        DIR_PATHS: '${{ inputs.dir-paths }}'
      run: |
        if [ "${FILE_PATHS}" != "" ]; then
          FILE_PATHS=$(echo "${FILE_PATHS}" | tr '\n' ' ')
          echo "Zipping the provided file paths: ${FILE_PATHS}"
        fi

        if [ "${DIR_PATHS}" != "" ]; then
          echo "Checking if all dirs in the list '${DIR_PATHS}' exists..."
          for dir in $($DIR_PATHS); do 
            echo "Provided dir path is $dir";
            if [ ! -d ${dir} ]; then
              echo "The provided dir path ${dir} is not a directory!"
              exit 1
            fi
          done
          DIR_PATHS=$(echo "${DIR_PATHS}" | tr '\n' ' ')
          echo "Zipping the provided dir paths: ${DIR_PATHS}"
        fi

        if [ -f terraform-config.tar.gz ]; then
          echo "Deleting existing file ${terraform-config.tar.gz}"
          rm -f terraform-config.tar.gz
        fi

        echo "Creating config stream with tar -czvf terraform-config.tar.gz ${FILE_PATHS} ${DIR_PATHS}"
        tar -czvf terraform-config.tar.gz ${FILE_PATHS} ${DIR_PATHS}

        echo "Making sure they are in place"
        tar -tvf terraform-config.tar.gz

    - id: response
      name: Set up for streaming
      shell: bash
      run: |
        docker run -v $(pwd):$(pwd) -w $(pwd) schmitzi/openssl-alpine-j11:1.2.0 openssl base64 -e -A -in terraform-config.tar.gz -out terraform-config-stream.base64
        ls -la terraform-config-stream.base64

        BASE64_STREAM=$(cat terraform-config-stream.base64)
        echo "Result of terraform config for base64 stream: ${BASE64_STREAM}"

        echo "Verifying"
        base64 -d terraform-config-stream.base64 > terraform-config.tar.gz.original
        ls -la terraform-config.tar.gz.original
        ls -la terraform-config.tar.gz

        echo "base64Stream=${BASE64_STREAM}" >> $GITHUB_OUTPUT
