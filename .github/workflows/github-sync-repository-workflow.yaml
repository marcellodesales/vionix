####
#### Author: Marcello DeSales (@mdesales)
####
# Syncs the current github repository with a remote one
name: docker-image-devsecops-cicd

# Avoid multiple CI jobs to execute for multiple commits in a given branch
# section #6: Saving Computation Time by Stopping Obsolete Workflows
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.local-repository }}
  cancel-in-progress: true

on:
  # Manual workflow execution
  # https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch
  # https://github.com/actions/runner/issues/1483#issuecomment-969295757
  # https://github.com/orgs/community/discussions/25595#discussioncomment-3248417
  workflow_call:
    inputs:
      seceng-devsecops-dind-runner-label:
        description: "Docker-in-docker (dind) runner to use base label"
        required: false
        type: string
        # Base image for the label is at https://git.viasat.com/seceng-devsecops-platform/devsecops-platform-runtime-github_actions_runner
        default: devsecops

      local-repository:
        description: "The local repository from git.viasat.com"
        required: true
        type: string

      remote-repository:
        description: "The remote repository from github.com"
        required: true
        type: string

    # We need to declare the intent of secrets. The pipelines reusing this must declare them!
    # https://github.com/orgs/community/discussions/26749#discussioncomment-3253230
    secrets:

      GITOPS_GITHUB_DEPLOY_PAT:
        description: "The token to clone and push changes to the GitOps Deploy repo"
        required: false

# https://faun.pub/building-a-ci-cd-pipeline-with-github-actions-and-docker-part-1-a9d8709c31fb
jobs:

  sync:
    name: 🔃 sync
    runs-on: ${{ inputs.seceng-devsecops-dind-runner-label }}

    # Add permissions to the score of the security events
    # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions
    permissions:
      contents: write  # <--- allows to read repo
      security-events: read

    steps:

      - name: Summary for what will be updated
        run: |
          echo "# ⤵️ sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "* Repo: ${GITHUB_SERVER_URL}/${{ inputs.local-repository }}" >> $GITHUB_STEP_SUMMARY
          echo "* Upstream: ${{ inputs.remote-repository }}" >> $GITHUB_STEP_SUMMARY

      - name: repo-sync
        uses: seceng-devsecops-platform/github-mirror-repo-sync-action@bugfix/SSEE-18072/fix-sync-as-mirror-git-repo
        with:
          target_repo: ${{ inputs.local-repository }}
          source_repo: ${{ inputs.remote-repository }}
          github_token: ${{ secrets.GITOPS_GITHUB_DEPLOY_PAT }}
          sync_tags: true
