####
#### Author: Marcello DeSales (@mdesales)
####
# Syncs the current github repository with a remote one
name: docker-image-devsecops-cicd

# Avoid multiple CI jobs to execute for multiple commits in a given branch
# section #6: Saving Computation Time by Stopping Obsolete Workflows
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  # Manual workflow execution
  # https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch
  # https://github.com/actions/runner/issues/1483#issuecomment-969295757
  # https://github.com/orgs/community/discussions/25595#discussioncomment-3248417
  workflow_call:
    inputs:
      seceng-devsecops-dind-runner-label:
        description: "Docker-in-docker (dind) runner to use base label"
        required: false
        type: string
        # Base image for the label is at https://git.viasat.com/seceng-devsecops-platform/devsecops-platform-runtime-github_actions_runner
        default: devsecops

      remote-repository:
        description: "The remote repository from github.com"
        required: true
        type: string
        default: docker-compose.yaml

    # We need to declare the intent of secrets. The pipelines reusing this must declare them!
    # https://github.com/orgs/community/discussions/26749#discussioncomment-3253230
    secrets:

      GITOPS_GITHUB_DEPLOY_PAT:
        description: "The token to clone and push changes to the GitOps Deploy repo"
        required: false

# https://faun.pub/building-a-ci-cd-pipeline-with-github-actions-and-docker-part-1-a9d8709c31fb
jobs:

  deploy:
    name: üèóÔ∏è gitops
    runs-on: ${{ inputs.seceng-devsecops-dind-runner-label }}

    # Add permissions to the score of the security events
    # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions
    permissions:
      contents: write  # <--- allows to read repo
      security-events: read

    steps:
      # Checkout always fetches the whole repo. Depending on the size, this will be super long
      - name: Fetch only the top commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Annotate Job with current information for DEV and STG
        working-directory: ${{ inputs.docker-compose-context }}
        run: |
          ls -la
      - name: repo-sync
        uses: seceng-devsecops-platform/repo-sync-github-sync-action@feature/DEVSECOPS-978/update-mirrored-repos-latest
        with:
          source_repo: ${{ inputs.remote-repository }}
          source_branch: ""
          destination_branch: ""
          github_token: ${{ secrets.GITOPS_GITHUB_DEPLOY_PAT }}
          sync_tags: true
#
#  report:
#    name: üì¢ notify
#    # https://stackoverflow.com/questions/63148639/create-dependencies-between-jobs-in-github-actions/63148947#63148947
#    # https://github.community/t/sharing-a-variable-between-jobs/16967/14
#    runs-on: ${{ inputs.seceng-devsecops-dind-runner-label }}
#
#    # https://stackoverflow.com/questions/58858429/how-to-run-a-github-actions-step-even-if-the-previous-step-fails-while-still-f/58859404#58859404
#    if: ${{ always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop' || github.ref_type == 'tag') }}
#
#    # https://github.com/github-community/community/discussions/15452#discussioncomment-2668767
#    #continue-on-error: true
#
#    needs: [code, build, deploy]
#
#    # providing permissions
#    permissions:
#      # Used for identity the github status results
#      # https://github.com/technote-space/workflow-conclusion-action/issues/122
#      contents: read
#      # https://docs.github.com/en/rest/actions/workflow-jobs?apiVersion=2022-11-28#list-jobs-for-a-workflow-run
#      actions: read
#
#    steps:
#      # run this action to get the workflow conclusion, if any of the previous jobs failed, it will fail the whole workflow
#      # You can get the conclusion via env (env.WORKFLOW_CONCLUSION)
#      - uses: seceng-devsecops-platform/technote-space-workflow-conclusion-action@v3.0.3
#
#      - name: Slack Notification of successful build of https://git.viasat.com/${{ github.repository }}@${{ github.ref }}
#        uses: seceng-devsecops-platform/wearerequired-slack-messaging-action@v2.0.2
#        # Populated by technote-space-workflow-conclusion-action above
#        # # neutral, success, skipped, cancelled, timed_out, action_required, failure
#        if: ${{ env.WORKFLOW_CONCLUSION == 'success' }}
#        with:
#          bot_token: ${{ secrets.SLACK_CHANNEL_AUTOMATION_TOKEN }}
#          channel_id: ${{ secrets.SLACK_CHANNEL_AUTOMATION_ID }}
#          message_id: ${{ needs.code.outputs.slackMessageId }} # Updates existing message from the first step.
#          payload: >-
#            {
#                "text": ":github_octocat: *${{ github.repository }}* :firework-2: *CI Passed* :viasat-signal-animated-transparent: \n <https://git.viasat.com/${{ github.repository }}|${{ github.repository }}>",
#                "attachments": [
#                    {
#                        "color": "warning",
#                        "fields": [
#                            {
#                              "title": "#Ô∏è‚É£ Revision",
#                              "value": "<https://git.viasat.com/${{ github.repository }}/commit/${{needs.code.outputs.gitShortSha}}|${{needs.code.outputs.gitShortSha}}>",
#                              "short": true
#                            },
#                            {
#                              "title": "üåø Branch",
#                              "value": "<https://git.viasat.com/${{ github.repository }}/tree/${{needs.code.outputs.defaultDockerImageBranchTag}}|${{needs.code.outputs.defaultDockerImageBranchTag}}>",
#                              "short": true
#                            },
#                            {
#                              "title": "üë§ Author",
#                              "value": "<${{ github.event.sender.html_url }}|${{needs.code.outputs.committerName}}, ${{needs.code.outputs.committerEmail}}>",
#                              "short": true
#                            },
#                            {
#                              "title": "üöÄ deploy Job",
#                              "value": "<https://git.viasat.com/${{ github.repository }}/actions/runs/${{github.run_id}}|${{github.run_id}}>",
#                              "short": true
#                            },
#                            {
#                              "title": "üê≥ Docker Image",
#                              "value": "<https://artifactory.viasat.com/ui/repos/tree/General/${{needs.code.outputs.githubOrg}}/${{needs.build.outputs.githubRepoPaths}}/${{needs.build.outputs.originalDockerImageTag}}-${{needs.code.outputs.defaultDockerImageBranchShaTag}}|${{needs.build.outputs.defaultDockerImageRepo}}-${{needs.code.outputs.defaultDockerImageBranchShaTag}}>",
#                              "short": true
#                            }
#                        ],
#                        "footer": "<${{needs.code.outputs.githubActionJobUrl}}>"
#                    }
#                ]
#            }
#
#      - name: Slack Notification build failure of https://git.viasat.com/${{ github.repository }}@${{ github.ref }}
#        uses: seceng-devsecops-platform/wearerequired-slack-messaging-action@v2.0.2
#
#        # Populated by technote-space-workflow-conclusion-action above
#        # # neutral, success, skipped, cancelled, timed_out, action_required, failure
#        if: ${{ env.WORKFLOW_CONCLUSION == 'failure' }}
#        with:
#          bot_token: ${{ secrets.SLACK_CHANNEL_AUTOMATION_TOKEN }}
#          channel_id: ${{ secrets.SLACK_CHANNEL_AUTOMATION_ID }}
#          message_id: ${{ needs.code.outputs.slackMessageId }} # Updates existing message from the first step.
#          payload: >-
#            {
#                "text": ":github_octocat: *${{ github.repository }}* :tire-fire: *CI Failed* :viasat-signal-animated-transparent: \n <https://git.viasat.com/${{ github.repository }}|${{ github.repository }}>",
#                "attachments": [
#                    {
#                        "color": "failure",
#                        "fields": [
#                            {
#                              "title": "#Ô∏è‚É£ Revision",
#                              "value": "<https://git.viasat.com/${{ github.repository }}/commit/${{needs.code.outputs.gitShortSha}}|${{needs.code.outputs.gitShortSha}}>",
#                              "short": true
#                            },
#                            {
#                              "title": "üåø Branch",
#                              "value": "<https://git.viasat.com/${{ github.repository }}/tree/${{needs.code.outputs.defaultDockerImageBranchTag}}|${{needs.code.outputs.defaultDockerImageBranchTag}}>",
#                              "short": true
#                            },
#                            {
#                              "title": "üë§ Author",
#                              "value": "<${{ github.event.sender.html_url }}|${{needs.code.outputs.committerName}}, ${{needs.code.outputs.committerEmail}}>",
#                              "short": true
#                            },
#                            {
#                              "title": "üöÄ deploy Job",
#                              "value": "<https://git.viasat.com/${{ github.repository }}/actions/runs/${{github.run_id}}|${{github.run_id}}>",
#                              "short": true
#                            },
#                            {
#                              "title": "üê≥ Docker Image",
#                              "value": "<https://artifactory.viasat.com/ui/repos/tree/General/${{needs.code.outputs.githubOrg}}/${{needs.build.outputs.githubRepoPaths}}/${{needs.code.outputs.defaultDockerImageBranchShaTag}}|${{needs.build.outputs.defaultDockerImageRepo}}-${{needs.code.outputs.defaultDockerImageBranchShaTag}}>",
#                              "short": true
#                            }
#                        ],
#                        "footer": "<${{needs.code.outputs.githubActionJobUrl}}>"
#                    }
#                ]
#            }
