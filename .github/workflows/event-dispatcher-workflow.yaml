#######
####### Author: Marcello.DeSales@viasat.com
#######
####### Distatches events to workflows

name: event-dispatcher-workflow

on:
  workflow_call:
    inputs:
      vionix-devsecops-dind-runner-label:
        description: "Docker-in-docker (dind) runner to use base label"
        required: false
        type: string
        default: devsecops

      github-org-repo:
          description: "The Github Org/Repo that needs to receive the dispatch event"
          required: true
          type: string

      event-type:
          description: "The name of the event to be dispatched"
          required: true
          type: string

      event-payload:
          description: "The object to be submitted based on the event type definition"
          required: true
          type: string
jobs:
  lint:
    name:  lint
    runs-on: ${{ inputs.vionix-devsecops-dind-runner-label }}
    steps:
      - name: Checkout the current sources
        uses: viarise/checkout@v3.5.3

      - name: Generate md report Check workflow files under .github/workflows using linter
        shell: bash
        # The docker container fails with 1 when findings, so make sure it passes
        # The exception will come from the problem-matcher below
        run: |
          echo "Preparing the report linter in .md format"
          docker run -v $(pwd):$(pwd) -w $(pwd) dockerhub.docker.artifactory.viasat.com/rhysd/actionlint:1.6.26 -format '{{range $err := .}}### Error at line {{$err.Line}}, col {{$err.Column}} of `{{$err.Filepath}}`\n\n{{$err.Message}}\n\n```\n{{$err.Snippet}}\n```\n\n{{end}}' > workflows-linter.md || true
          ls -la workflows-linter.md
      - name: Enrich the generated md report
        run: |
          ls -la workflows-linter.md
          echo "Processing the file to categorize alerts for summary and PR"
          # Check if the line contains the start of a new block
          current_block_name=""
          # Read the file line by line
          while IFS= read -r line; do
            if [[ $line == "### Error"* ]]; then
              # Get the block name from the file name
              block_name=$(echo "$line" | cut -d'`' -f2)
              # Only add the block if the current is different
              if [ "${current_block_name}" != "${block_name}" ]; then
                # Add the close block when it's not empty, as empty will be the beginning
                if [ "${current_block_name}" != "" ]; then
                  echo "</details>"
                fi
                # Update the reference
                current_block_name=$block_name
                echo "<details>"
                echo "<summary> :octocat: Action Lint Errors in '$block_name'</summary>"
                echo ""
              fi
              # Print the current line as a subblock of the current block
              sub_block_text=$(echo "$line" | awk -F"### " '{ print $2 }')
              echo "ðŸš¨ ${sub_block_text}"
              # Just continue because we are just processing the headers
              continue
            fi
            # Print the current line as a subblock of the current block
            echo "$line"
          done < workflows-linter.md > new-report.md
          echo "# ðŸš¨ï¸ Github Actions Lint" >> header.md
          echo "> **Formatted by the Vionix DevSecOps Platform**" >> header.md
          echo "" >> header.md
          cat new-report.md >> header.md
          mv header.md workflows-linter.md
          ls -la workflows-linter.md
      - name: Add Lint PR Comment
        uses: seceng-devsecops-platform/marocchino-sticky-pull-request-comment-action@v2.8.0
        if: ${{ always() && github.event_name == 'pull_request' }}
        with:
          header: github-action-lint
          recreate: true
          path: workflows-linter.md

      - name: Annotate Workflow Summary with lint info
        run: |
          cat workflows-linter.md >> $GITHUB_STEP_SUMMARY
      - name: Checkout Vionix Platform workflows
        uses: viarise/checkout@v3.5.3
        with:
          repository: seceng-devsecops-platform/devsecops-platform-github-workflows
          ref: master
          path: ./platform-actions
          # https://github.com/stefanzweifel/git-auto-commit-action#push-to-protected-branches
          token: ${{ secrets.GITHUB_TOKEN }}

        # setting up the problem matcher https://github.com/facebookresearch/fairseq2/blob/main/.github/workflows/_lint_py.yaml
      - name: Install the problem matchers for github actions
        shell: bash
        env:
          MATCHER: actionlint
        run: |
          ls -laR ./platform-actions/.github
          if [ -f ./platform-actions/.github/${MATCHER}-problem-matcher.json ]; then
            echo "Will use the problem matcher ./platform-actions/.github/${MATCHER}-problem-matcher.json"
            cat ./platform-actions/.github/${MATCHER}-problem-matcher.json | jq
            echo "::add-matcher::./platform-actions/.github/${MATCHER}-problem-matcher.json"
          fi
      # This requires the problem matcher to be installed
      #
      - name: Check workflow files under .github/workflows using github linter for problem matcher
        shell: bash
        continue-on-error: ${{ inputs.dont-fail-on-errors }}
        run: docker run -v $(pwd):$(pwd) -w $(pwd) dockerhub.docker.artifactory.viasat.com/rhysd/actionlint:1.6.26 -color -format '{{range $err := .}}::error file={{$err.Filepath}},line={{$err.Line}},col={{$err.Column}}::{{$err.Message}}%0A```%0A{{replace $err.Snippet "\\n" "%0A"}}%0A```\n{{end}}' -ignore 'SC2016:'
FooterViaSat, Inc.
ViaSat, Inc.
