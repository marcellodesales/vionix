####
#### Author: Marcello DeSales (@mdesales)
####
# Executes Terraform workflows using Viasat's Artifactory Repository for State/Cache 
# https://www.freecodecamp.org/news/a-lightweight-tool-agnostic-ci-cd-flow-with-github-actions/
# Base Workflow: https://git.viasat.com/S2E2/scanners_onboarding_framework/blob/feature/SSEE-8699/automated-deployments-with-containerized-terraform/.github/workflows/ops-deploy-lambdas.yaml

name: terraform-devsecops-workflow

# Avoid multiple CI jobs to execute for multiple commits in a given branch
# section #6: Saving Computation Time by Stopping Obsolete Workflows
concurrency:
  group: terraform-cd-devsecops-${{ github.ref }}-1
  cancel-in-progress: true

on:
  # Manual workflow execution
  # https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch
  # https://github.com/actions/runner/issues/1483#issuecomment-969295757
  # https://github.com/orgs/community/discussions/25595#discussioncomment-3248417
  workflow_call:
    inputs:
      seceng-devsecops-dind-runner-label:
        description: "Docker-in-docker (dind) runner to use base label"
        required: false
        type: string
        # Base image for the label is at https://git.viasat.com/seceng-devsecops-platform/devsecops-platform-runtime-github_actions_runner
        default: devsecops

      ghasEnabled:
        description: "Status of the GHAS onboarding"
        required: false
        type: string
        # Base image for the label is at https://git.viasat.com/seceng-devsecops-platform/devsecops-platform-runtime-github_actions_runner
        default: "false"

      config-stream:
        description: "The base64 stream of files required to execute terraform"
        required: false
        type: string
        default: ""

      terraform-environment-name:
        description: "The name of the environment to deploy to, associated with the Github environment to be defined. Go to Settings -> Environments"
        required: false
        type: string
        default: default

      terraform-environment-url:
        description: "The URL to be placed as a link when the Github UI shows the deployment success and take developers to."
        required: false
        type: string
        default: https://git.viasat.com

    # We need to declare the intent of secrets. The pipelines reusing this must declare them!
    # https://github.com/orgs/community/discussions/26749#discussioncomment-3253230
    secrets:
      ARTIFACTORY_SVC_USER:
        description: "The username of the service account for Artifactory Docker registry Repository"
        required: true

      ARTIFACTORY_SVC_PASS:
        description: "The password associated with the username of the service account for Artifactory Docker registry Repository"
        required: true

      SLACK_CHANNEL_AUTOMATION_ID:
        description: "The Slack Automation ID"
        required: false

      SLACK_CHANNEL_AUTOMATION_TOKEN:
        description: "The token for the given Slack channel ID"
        required: false

# https://faun.pub/building-a-ci-cd-pipeline-with-github-actions-and-docker-part-1-a9d8709c31fb
jobs:

  lint:
    name: ðŸš¨ lint
    runs-on: ${{ inputs.seceng-devsecops-dind-runner-label }}
    strategy:
      fail-fast: false

    # Maybe to get twistlock action to run we need permission to read
    # https://github.com/actions/checkout/issues/254#issuecomment-1166945991
    permissions:
      contents: read  # <--- allows to read repo
      # Enable pull request reads for 8BitJonny/gh-get-current-pr, avoid error "Resource not accessible by integration"
      # https://github.com/actions/first-interaction/issues/10#issuecomment-1232740076
      pull-requests: write

    steps:
      # Checkout visibility from action https://github.com/actions/runner/issues/1300#issuecomment-990373768
      # Isolated actions doesn't have access to the cloned repo from workflows... it needs to clone them for now
      # Fixed on GHES 3.5 from June 6, 2022 https://github.com/github/roadmap/issues/74#issuecomment-1147906530
      - name: Checkout Current Repository
        uses: viarise/checkout@v3.5.3

      # https://github.com/docker/build-push-action/issues/225#issuecomment-727639184
      - name: Decode the config stream
        uses: seceng-devsecops-platform/devsecops-platform-github-workflows/actions/build/config-stream-decoder@main
        with:
          config-stream: ${{ inputs.config-stream }}

      - name: List of downloaded secret files
        id: tfsec-check-values
        run: |
          ls -laR --ignore=.git

      - name: Execute the check terraform
        id: terraform-validate
        env:
          CURRENT_DIR: ${{ github.workspace }}
        run: |
          docker compose run terraform-validate

  check:
    name: ðŸ›¡ï¸ï¸ check
    if: ${{ inputs.ghasEnabled == 'true' }}
    needs: [lint]
    runs-on: ${{ inputs.seceng-devsecops-dind-runner-label }}
    strategy:
      fail-fast: false
      matrix:
        checkType: [terrascan,tfsec]

    # Maybe to get twistlock action to run we need permission to read
    # https://github.com/actions/checkout/issues/254#issuecomment-1166945991
    permissions:
      contents: read  # <--- allows to read repo
      # Enable pull request reads for 8BitJonny/gh-get-current-pr, avoid error "Resource not accessible by integration"
      # https://github.com/actions/first-interaction/issues/10#issuecomment-1232740076
      # only required for workflows in private repositories
      pull-requests: write
      # https://docs.github.com/en/code-security/code-scanning/integrating-with-code-scanning/uploading-a-sarif-file-to-github#uploading-a-code-scanning-analysis-with-github-actions
      actions: read
      security-events: write

    steps:
      # Checkout visibility from action https://github.com/actions/runner/issues/1300#issuecomment-990373768
      # Isolated actions doesn't have access to the cloned repo from workflows... it needs to clone them for now
      # Fixed on GHES 3.5 from June 6, 2022 https://github.com/github/roadmap/issues/74#issuecomment-1147906530
      - name: Checkout Current Repository
        uses: viarise/checkout@v3.5.3

      - name: Execute the security linter tfsec
        if: ${{ matrix.checkType == 'tfsec' }}
        id: tfsec-check-values
        env:
          CURRENT_DIR: ${{ github.workspace }}
        run: |
          docker compose run terraform-tfsec
          echo "Generated the file terraform-check.text"
          cat terraform-check.text
          echo "Generated the file terraform-check.markdown"
          cat terraform-check.markdown >> $GITHUB_STEP_SUMMARY

      # Add the tfsec comments to the PR
      - name: Add tfsec comments to PR
        if: ${{ matrix.checkType == 'tfsec' }}
        uses: aquasecurity/tfsec-pr-commenter-action@v1.3.1
        with:
        # tfsec_args: --soft-fail
          soft_fail_commenter: true
          tfsec_formats: sarif,json,gif
          github_token: ${{ github.token }}

      - name: Upload SARIF file for tfsec
        if: ${{ matrix.checkType == 'tfsec' }}
        uses: github/codeql-action/upload-sarif@v2
        with:
          # Path to SARIF file relative to the root of the repository
          sarif_file: terraform-check.sarif.json
          # Optional category for the results
          # Used to differentiate multiple results for one commit
          category: tfsec

      - name: Run Terrascan
        if: ${{ matrix.checkType == 'terrascan' }}
        id: terrascan
        uses: seceng-devsecops-platform/tenable-terrascan-action@v1.5.0
        # https://github.com/tenable/terrascan-action/blob/main/README.md
        with:
          iac_type: 'terraform'
          # iac_version: 'v14'
          policy_type: 'gcp'
          only_warn: true
          #scm_token: ${{ secrets.ACCESS_TOKEN }}
          #verbose: true
          sarif_upload: true
          #non_recursive:
          #iac_dir:
          #policy_path:
          #skip_rules:
          config_path: terrascan-config.toml
          #find_vulnerabilities:
          #webhook_url:
          #webhook_token:

      - name: Upload SARIF file for terrascan
        if: ${{ matrix.checkType == 'terrascan' }}
        uses: github/codeql-action/upload-sarif@v2
        with:
          # Path to SARIF file relative to the root of the repository
          sarif_file: terrascan.sarif
          # Optional category for the results
          # Used to differentiate multiple results for one commit
          category: terrascan

  plan:
    name: ðŸ“ï¸ plan
    needs: [lint]
    runs-on: ${{ inputs.seceng-devsecops-dind-runner-label }}

    strategy:
      fail-fast: true

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TF_IN_AUTOMATION: true

    steps:
      # Checkout visibility from action https://github.com/actions/runner/issues/1300#issuecomment-990373768
      # Isolated actions doesn't have access to the cloned repo from workflows... it needs to clone them for now
      # Fixed on GHES 3.5 from June 6, 2022 https://github.com/github/roadmap/issues/74#issuecomment-1147906530
      - name: Fetch all commits from the repo
        uses: viarise/checkout@v3.5.3

      - name: Decode the config stream
        uses: seceng-devsecops-platform/devsecops-platform-github-workflows/actions/build/config-stream-decoder@main
        with:
          config-stream: ${{ inputs.config-stream }}

      - name: List of downloaded secret files
        run: |
          ls -laR --ignore=.git

      - name: Terraform plan in container
        id: plan
        env:
          CURRENT_DIR: ${{ github.workspace }}
        run: |
          # This now writes the plan and the terraform binary for the j2md conversion
          docker compose run terraform-plan

      - name: Install j2md - Plan to md
        if: always() && github.ref != 'refs/heads/main' && (steps.plan.outcome == 'success' || steps.plan.outcome == 'failure')
        uses: seceng-devsecops-platform/reproio-terraform-j2md-action@v0.0.9
        with:
          version: v0.0.9

      - name: convert plan to md
        # NOTE: This is reusing the terraform binary provided by the terraform docker image of the docker-compose from the contract
        run: |
          which terraform-j2md
          ./terraform show -json plan.tfplan | terraform-j2md > terraform-plan.md

          echo "ðŸ“ï¸ Terraform plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat terraform-plan.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Add plan to PR Comment
        uses: seceng-devsecops-platform/marocchino-sticky-pull-request-comment-action@v2
        if: github.event_name == 'pull_request'
        with:
          recreate: true
          path: terraform-plan.md

  deploy:
    name:  ðŸš€ deploy
    needs: [plan]
    runs-on: ${{ inputs.seceng-devsecops-dind-runner-label }}

    # TODO: turn this on when we have 2 envs
    # if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'master'

    # https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment
    environment:
      name: ${{ inputs.terraform-environment-name }}
      url: ${{ inputs.terraform-environment-url }}

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TF_IN_AUTOMATION: true

    steps:
      # Checkout visibility from action https://github.com/actions/runner/issues/1300#issuecomment-990373768
      # Isolated actions doesn't have access to the cloned repo from workflows... it needs to clone them for now
      # Fixed on GHES 3.5 from June 6, 2022 https://github.com/github/roadmap/issues/74#issuecomment-1147906530
      - name: Fetch top commit from the repo
        uses: viarise/checkout@v3.5.3

      # https://github.com/docker/build-push-action/issues/225#issuecomment-727639184
      - name: Decode the config stream
        uses: seceng-devsecops-platform/devsecops-platform-github-workflows/actions/build/config-stream-decoder@main
        with:
          config-stream: ${{ inputs.config-stream }}

      - name: List of downloaded secret files
        run: |
          ls -laR --ignore=.git

      - name: Terraform Apply
        run: |
          echo "Generating the workflow plan file"
          docker compose run terraform-plan
          
          echo "Deploying with apply"
          docker compose run terraform-apply
